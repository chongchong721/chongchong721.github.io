<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
<!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Downsample Mipmap | Yuan’s site(MY site)</title>
<meta name="generator" content="Jekyll v3.10.0">
<meta property="og:title" content="Downsample Mipmap">
<meta property="og:locale" content="en_US">
<meta name="description" content="Downsample A Cubemap Mipmap">
<meta property="og:description" content="Downsample A Cubemap Mipmap">
<link rel="canonical" href="https://chongchong721.github.io/2024/10/10/Downsample-mipmap.html">
<meta property="og:url" content="https://chongchong721.github.io/2024/10/10/Downsample-mipmap.html">
<meta property="og:site_name" content="Yuan’s site(MY site)">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2024-10-10T00:00:00+00:00">
<meta name="twitter:card" content="summary">
<meta property="twitter:title" content="Downsample Mipmap">
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2024-10-10T00:00:00+00:00","datePublished":"2024-10-10T00:00:00+00:00","description":"Downsample A Cubemap Mipmap","headline":"Downsample Mipmap","mainEntityOfPage":{"@type":"WebPage","@id":"https://chongchong721.github.io/2024/10/10/Downsample-mipmap.html"},"url":"https://chongchong721.github.io/2024/10/10/Downsample-mipmap.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css">
<link type="application/atom+xml" rel="alternate" href="https://chongchong721.github.io/feed.xml" title="Yuan's site(MY site)">
<script>MathJax={"tex":{"inlineMath":[["$","$"],["\\(","\\)"]],"displayMath":[["$$","$$"],["\\[","\\]"]]},"svg":{"fontCache":"global"}}</script><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
</head>
<body>
<header class="site-header" role="banner">

  <div class="wrapper">
<a class="site-title" rel="author" href="/">Yuan's site(MY site)</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger">
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewbox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"></path>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About Myself</a></div>
      </nav>
</div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Downsample Mipmap</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2024-10-10T00:00:00+00:00" itemprop="datePublished">Oct 10, 2024
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <h3 id="downsample-a-cubemap-mipmap">Downsample A Cubemap Mipmap</h3>

<p>In the Activision paper of fast filtering of GGX reflection probe, the author proposed a smoother downsample routine. However, it seems like the code the author provided is not doing what they discussed in their paper.</p>

<p>A B-spline kernel is used for downsampling. And Jacobian terms are used to account for the distortion from cubemap to sphere mapping</p>

<blockquote>
  <p>Quadratic b-splines are smooth, but the projection of a constant function over a sphere onto a cubemap is not smooth between faces. To get a basis that better approximates a constant over a sphere, we weight each of the samples in the b-spline recurrence by the Jacobian, J(x, y, z). Weighting samples by the Jacobian has the desired effect of giving less weight to corners and edges, and produces functions that are smooth everywhere except for at edges.</p>
</blockquote>

<p>This means, for a value $v$ at a cubemap location $(x,y,z)$, we weight it by
$$
v * \frac{1}{(x^2 + y^2 + z^2)^{\frac{3}{2}}}
$$
By doing this, less weight is given to the locations near corners and edges.</p>

<p>However, the code seems to be doing the contrary:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">float</span> <span class="nf">calcWeight</span><span class="p">(</span> <span class="kt">float</span> <span class="n">u</span><span class="p">,</span> <span class="kt">float</span> <span class="n">v</span> <span class="p">)</span>
<span class="p">{</span>
	<span class="kt">float</span> <span class="n">val</span> <span class="o">=</span> <span class="n">u</span><span class="o">*</span><span class="n">u</span> <span class="o">+</span> <span class="n">v</span><span class="o">*</span><span class="n">v</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">val</span><span class="o">*</span><span class="n">sqrt</span><span class="p">(</span> <span class="n">val</span> <span class="p">);</span>
<span class="p">}</span>
<span class="kt">float</span> <span class="n">weights</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
<span class="n">weights</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">calcWeight</span><span class="p">(</span> <span class="n">u0</span><span class="p">,</span> <span class="n">v0</span> <span class="p">);</span>
<span class="n">weights</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">calcWeight</span><span class="p">(</span> <span class="n">u1</span><span class="p">,</span> <span class="n">v0</span> <span class="p">);</span>
<span class="n">weights</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">calcWeight</span><span class="p">(</span> <span class="n">u0</span><span class="p">,</span> <span class="n">v1</span> <span class="p">);</span>
<span class="n">weights</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">calcWeight</span><span class="p">(</span> <span class="n">u1</span><span class="p">,</span> <span class="n">v1</span> <span class="p">);</span>

<span class="k">const</span> <span class="kt">float</span> <span class="n">wsum</span> <span class="o">=</span> <span class="mf">0.5</span><span class="n">f</span> <span class="o">/</span> <span class="p">(</span> <span class="n">weights</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">weights</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">weights</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">weights</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="p">);</span>
<span class="p">[</span><span class="n">unroll</span><span class="p">]</span>
<span class="k">for</span> <span class="p">(</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span> <span class="p">)</span>
    <span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">wsum</span> <span class="o">+</span> <span class="mf">.125</span><span class="n">f</span><span class="p">;</span>

<span class="n">get_dir_0</span><span class="p">(</span> <span class="n">dir</span><span class="p">,</span> <span class="n">u0</span><span class="p">,</span> <span class="n">v0</span> <span class="p">);</span>
<span class="n">color</span> <span class="o">=</span> <span class="n">tex_hi_res</span><span class="p">.</span><span class="n">SampleLevel</span><span class="p">(</span> <span class="n">bilinear</span><span class="p">,</span> <span class="n">dir</span><span class="p">,</span> <span class="mi">0</span> <span class="p">)</span> <span class="o">*</span> <span class="n">weights</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

<span class="n">get_dir_0</span><span class="p">(</span> <span class="n">dir</span><span class="p">,</span> <span class="n">u1</span><span class="p">,</span> <span class="n">v0</span> <span class="p">);</span>
<span class="n">color</span> <span class="o">+=</span> <span class="n">tex_hi_res</span><span class="p">.</span><span class="n">SampleLevel</span><span class="p">(</span> <span class="n">bilinear</span><span class="p">,</span> <span class="n">dir</span><span class="p">,</span> <span class="mi">0</span> <span class="p">)</span> <span class="o">*</span> <span class="n">weights</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

<span class="n">get_dir_0</span><span class="p">(</span> <span class="n">dir</span><span class="p">,</span> <span class="n">u0</span><span class="p">,</span> <span class="n">v1</span> <span class="p">);</span>
<span class="n">color</span> <span class="o">+=</span> <span class="n">tex_hi_res</span><span class="p">.</span><span class="n">SampleLevel</span><span class="p">(</span> <span class="n">bilinear</span><span class="p">,</span> <span class="n">dir</span><span class="p">,</span> <span class="mi">0</span> <span class="p">)</span> <span class="o">*</span> <span class="n">weights</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

<span class="n">get_dir_0</span><span class="p">(</span> <span class="n">dir</span><span class="p">,</span> <span class="n">u1</span><span class="p">,</span> <span class="n">v1</span> <span class="p">);</span>
<span class="n">color</span> <span class="o">+=</span> <span class="n">tex_hi_res</span><span class="p">.</span><span class="n">SampleLevel</span><span class="p">(</span> <span class="n">bilinear</span><span class="p">,</span> <span class="n">dir</span><span class="p">,</span> <span class="mi">0</span> <span class="p">)</span> <span class="o">*</span> <span class="n">weights</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
<span class="k">break</span><span class="p">;</span>
</code></pre></div></div>

<p>So, this is weighting it by $\frac{1}{J(x,y,z)}$, it gives larger weight at corners and edges.</p>

  </div>
<a class="u-url" href="/2024/10/10/Downsample-mipmap.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Yuan's site(MY site)</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Yuan's site(MY site)</li>
<li><a class="u-email" href="mailto:fbzq125689@gmail.com">fbzq125689@gmail.com</a></li>
</ul>
      </div>

      <div class="footer-col footer-col-2">
<ul class="social-media-list"><li><a href="https://github.com/chongchong721"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">chongchong721</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>Personal website for sharing interesting things</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
